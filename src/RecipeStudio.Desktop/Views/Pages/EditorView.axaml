<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="clr-namespace:RecipeStudio.Desktop.Controls"
             mc:Ignorable="d"
             x:Class="RecipeStudio.Desktop.Views.Pages.EditorView">

  <Grid RowDefinitions="Auto,*" Margin="18">

    <!-- Header -->
    <Grid ColumnDefinitions="Auto,*,Auto,Auto" Margin="0,0,0,12">
      <Button Command="{Binding BackCommand}" Classes="ghost back-arrow" Width="42" Height="34" Padding="0">
        <TextBlock Text="‚Üê" HorizontalAlignment="Center" VerticalAlignment="Center" />
      </Button>

      <TextBlock Grid.Column="1" Text="–†–µ–¥–∞–∫—Ç–æ—Ä —Ä–µ—Ü–µ–ø—Ç–∞" Classes="h1" VerticalAlignment="Center" Margin="12,0,0,0" />

      <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center" Margin="0,0,8,0">
        <Button Classes="ghost panel-icon-btn" ToolTip.Tip="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤" Click="ShowParametersPanel_Click">‚öô</Button>
        <Button Classes="ghost panel-icon-btn" ToolTip.Tip="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏" Click="ShowVisualizationPanel_Click">üìà</Button>
        <Button Classes="ghost panel-icon-btn" ToolTip.Tip="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏" Click="ShowSelectedPointPanel_Click">‚óé</Button>
        <Button Classes="ghost panel-icon-btn" ToolTip.Tip="–°–±—Ä–æ—Å–∏—Ç—å –ø–∞–Ω–µ–ª–∏" Click="ResetPanels_Click">‚Ü∫</Button>
      </StackPanel>

      <Button Grid.Column="3" Command="{Binding SaveCommand}" Classes="accent">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</Button>
    </Grid>

    <Grid Grid.Row="1">

      <!-- Left: table -->
      <Border Classes="card" Margin="0">
        <Grid RowDefinitions="Auto,*">

          <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,10">
            <Button Command="{Binding AddPointCommand}" Classes="good">+ –¢–æ—á–∫–∞</Button>
            <Button Command="{Binding DuplicatePointCommand}" Classes="ghost">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</Button>
            <Button Command="{Binding RemovePointCommand}" Classes="danger">–£–¥–∞–ª–∏—Ç—å</Button>
            <Button Command="{Binding MoveUpCommand}" Classes="ghost">‚Üë</Button>
            <Button Command="{Binding MoveDownCommand}" Classes="ghost">‚Üì</Button>
            <Button Command="{Binding RecalculateCommand}" Classes="ghost">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</Button>
            <Button Command="{Binding ShowChartsCommand}" Classes="ghost">–ì—Ä–∞—Ñ–∏–∫–∏</Button>

            <Button Command="{Binding ImportExcelCommand}" Classes="ghost">–ò–º–ø–æ—Ä—Ç Excel</Button>
            <Button Command="{Binding ExportExcelCommand}" Classes="ghost">–≠–∫—Å–ø–æ—Ä—Ç Excel</Button>

            <TextBlock Text="{Binding Document.RecipeId, StringFormat='ID: {0}'}" Classes="muted" Margin="12,0,0,0" VerticalAlignment="Center" />
          </StackPanel>

          <DataGrid Grid.Row="1"
                    Classes="editor-grid"
                    ItemsSource="{Binding Points}"
                    SelectedItem="{Binding SelectedPoint}"
                    AutoGenerateColumns="False"
                    CanUserResizeColumns="True"
                    CanUserReorderColumns="False"
                    CanUserSortColumns="False"
                    IsReadOnly="False"
                    HeadersVisibility="All"
                    MinHeight="520"
                    FontSize="13"
                    RowHeight="34">

            <DataGrid.Columns>
              <DataGridTextColumn Binding="{Binding NPoint}" IsReadOnly="True" Width="40">
                <DataGridTextColumn.Header>
                  <TextBlock Text="#" Classes="grid-hdr" ToolTip.Tip="–ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —Ç–æ—á–∫–∏" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridCheckBoxColumn Binding="{Binding Act}" Width="40">
                <DataGridCheckBoxColumn.Header>
                  <TextBlock Text="A" Classes="grid-hdr" ToolTip.Tip="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ—á–∫–∏: 1 ‚Äî —É—á–∞—Å—Ç–≤—É–µ—Ç, 0 ‚Äî –≤—ã–∫–ª—é—á–µ–Ω–∞" />
                </DataGridCheckBoxColumn.Header>
              </DataGridCheckBoxColumn>

              <DataGridCheckBoxColumn Binding="{Binding Safe}" Width="40">
                <DataGridCheckBoxColumn.Header>
                  <TextBlock Text="S" Classes="grid-hdr" ToolTip.Tip="–ó–æ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Safe)" />
                </DataGridCheckBoxColumn.Header>
              </DataGridCheckBoxColumn>

              <DataGridTextColumn Binding="{Binding RCrd}" Width="66">
                <DataGridTextColumn.Header>
                  <TextBlock Text="R" Classes="grid-hdr hdr-green" ToolTip.Tip="–†–∞–¥–∏–∞–ª—å–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞, –º–º" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding ZCrd}" Width="66">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Z" Classes="grid-hdr hdr-green" ToolTip.Tip="–í—ã—Å–æ—Ç–∞ Z, –º–º" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding ANozzle}" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="a" Classes="grid-hdr" ToolTip.Tip="–î–∏–∞–º–µ—Ç—Ä —Å–æ–ø–ª–∞ a, –º–º" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding Alfa}" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Œ±" Classes="grid-hdr" ToolTip.Tip="–£–≥–æ–ª –∞–ª—å—Ñ–∞, ¬∞" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding Betta}" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Œ≤" Classes="grid-hdr" ToolTip.Tip="–£–≥–æ–ª –±–µ—Ç–∞, ¬∞" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding Place}" Width="62">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Top" Classes="grid-hdr hdr-blue" ToolTip.Tip="–°—Ç–æ—Ä–æ–Ω–∞/—É—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ (Top)" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridCheckBoxColumn Binding="{Binding Hidden}" Width="72">
                <DataGridCheckBoxColumn.Header>
                  <TextBlock Text="Micro" Classes="grid-hdr" ToolTip.Tip="–ú–∏–∫—Ä–æ-—Ä–µ–∂–∏–º (—Å–∫—Ä—ã—Ç–∞—è/—Å–ª—É–∂–µ–±–Ω–∞—è —Ç–æ—á–∫–∞)" />
                </DataGridCheckBoxColumn.Header>
              </DataGridCheckBoxColumn>

              <DataGridTextColumn Binding="{Binding SpeedTable}" Width="72">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Speed" Classes="grid-hdr" ToolTip.Tip="œâ ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å —Å—Ç–æ–ª–∞, –æ–±/–º–∏–Ω" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding TimeSec}" IsReadOnly="True" Width="64">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Time" Classes="grid-hdr" ToolTip.Tip="t, —Å–µ–∫ ‚Äî –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–¥–∞" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding IceRate}" Width="74">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Ice.R" Classes="grid-hdr hdr-violet" ToolTip.Tip="G_–∏–∑–º, –∫–≥/—á ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—Ö–æ–¥" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding IceGrind}" Width="74">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Ice.G" Classes="grid-hdr hdr-violet" ToolTip.Tip="–°—Ç–µ–ø–µ–Ω—å –ø–æ–º–æ–ª–∞/–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª—å–¥–∞" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding AirPressure}" Width="74">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Air.P" Classes="grid-hdr hdr-violet" ToolTip.Tip="P, –∞—Ç–º ‚Äî –¥–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–¥—É—Ö–∞" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding AirTemp}" Width="74">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Air.T" Classes="grid-hdr hdr-violet" ToolTip.Tip="T, ¬∞C ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–∑–¥—É—Ö–∞" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding NozzleSpeedMmMin}" IsReadOnly="True" Width="66">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Vel" Classes="grid-hdr hdr-orange" ToolTip.Tip="V, –º–º/–º–∏–Ω = round(2 * œÄ * R * Speed / 60), –≥–¥–µ œÄ = 3.14" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding RecommendedIceRate}" IsReadOnly="True" Width="66">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Flow" Classes="grid-hdr hdr-orange" ToolTip.Tip="–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ G, –∫–≥/—á" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding DX}" IsReadOnly="True" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Xm" Classes="grid-hdr" ToolTip.Tip="–ú–∞—à–∏–Ω–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
              <DataGridTextColumn Binding="{Binding DY}" IsReadOnly="True" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Ym" Classes="grid-hdr" ToolTip.Tip="–ú–∞—à–∏–Ω–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
              <DataGridTextColumn Binding="{Binding DZ}" IsReadOnly="True" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Zm" Classes="grid-hdr" ToolTip.Tip="–ú–∞—à–∏–Ω–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Z" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
              <DataGridTextColumn Binding="{Binding DA}" IsReadOnly="True" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Am" Classes="grid-hdr" ToolTip.Tip="–ú–∞—à–∏–Ω–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ A" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
              <DataGridTextColumn Binding="{Binding AB}" IsReadOnly="True" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Bm" Classes="grid-hdr" ToolTip.Tip="–ú–∞—à–∏–Ω–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ B" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding Xr0}" IsReadOnly="True" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Xr" Classes="grid-hdr hdr-red" ToolTip.Tip="–†–æ–±–æ—Ç-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
              <DataGridTextColumn Binding="{Binding Yx0}" IsReadOnly="True" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Yr" Classes="grid-hdr hdr-red" ToolTip.Tip="–†–æ–±–æ—Ç-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
              <DataGridTextColumn Binding="{Binding Zr0}" IsReadOnly="True" Width="56">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Zr" Classes="grid-hdr hdr-red" ToolTip.Tip="–†–æ–±–æ—Ç-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Z" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding XPuls}" IsReadOnly="True" Width="58">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Xp" Classes="grid-hdr hdr-deep-blue" ToolTip.Tip="–ò–º–ø—É–ª—å—Å—ã X" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
              <DataGridTextColumn Binding="{Binding YPuls}" IsReadOnly="True" Width="58">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Yp" Classes="grid-hdr hdr-deep-blue" ToolTip.Tip="–ò–º–ø—É–ª—å—Å—ã Y" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
              <DataGridTextColumn Binding="{Binding ZPuls}" IsReadOnly="True" Width="58">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Zp" Classes="grid-hdr hdr-deep-blue" ToolTip.Tip="–ò–º–ø—É–ª—å—Å—ã Z" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
              <DataGridTextColumn Binding="{Binding APuls}" IsReadOnly="True" Width="58">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Ap" Classes="grid-hdr hdr-deep-blue" ToolTip.Tip="–ò–º–ø—É–ª—å—Å—ã A" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
              <DataGridTextColumn Binding="{Binding BPuls}" IsReadOnly="True" Width="58">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Bp" Classes="grid-hdr hdr-deep-blue" ToolTip.Tip="–ò–º–ø—É–ª—å—Å—ã B" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>

              <DataGridTextColumn Binding="{Binding Description}" Width="140">
                <DataGridTextColumn.Header>
                  <TextBlock Text="Desc" Classes="grid-hdr" ToolTip.Tip="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–æ—á–∫–µ" />
                </DataGridTextColumn.Header>
              </DataGridTextColumn>
            </DataGrid.Columns>
          </DataGrid>

        </Grid>
      </Border>

      <!-- Movable / resizable panels overlay -->
      <Canvas x:Name="PanelsCanvas" ClipToBounds="True">
        <Border x:Name="ParametersPanel" Classes="card floating-panel"
                Width="390" Height="210" MinWidth="320" MinHeight="170"
                PointerPressed="Panel_PointerPressed" PointerMoved="Panel_PointerMoved" PointerReleased="Panel_PointerReleased">
          <Grid RowDefinitions="Auto,*">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã" FontSize="16" FontWeight="SemiBold" />
              <Button Grid.Column="1" Classes="ghost panel-close-btn" Click="HideParametersPanel_Click">‚úï</Button>
            </Grid>

            <Grid Grid.Row="1" ColumnDefinitions="150,*" RowDefinitions="Auto,Auto,Auto,Auto" Margin="0,10,0,0">
              <TextBlock Text="Recipe" VerticalAlignment="Center" />
              <TextBox Grid.Column="1" Text="{Binding RecipeCode}" />

              <TextBlock Grid.Row="1" Text="Container" VerticalAlignment="Center" />
              <CheckBox Grid.Row="1" Grid.Column="1" IsChecked="{Binding ContainerPresent}">–ï—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä</CheckBox>

              <TextBlock Grid.Row="2" Text="D clamp form" VerticalAlignment="Center" />
              <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding DClampForm}" />

              <TextBlock Grid.Row="3" Text="D clamp cont" VerticalAlignment="Center" />
              <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding DClampCont}" />
            </Grid>
          </Grid>
        </Border>
        <Border x:Name="ParametersResizeHandle" Classes="panel-resize-handle"
                PointerPressed="ResizeHandle_PointerPressed" PointerMoved="ResizeHandle_PointerMoved" PointerReleased="ResizeHandle_PointerReleased" />

        <Border x:Name="VisualizationPanel" Classes="card floating-panel"
                Width="520" Height="360" MinWidth="380" MinHeight="260"
                PointerPressed="Panel_PointerPressed" PointerMoved="Panel_PointerMoved" PointerReleased="Panel_PointerReleased">
          <Grid RowDefinitions="Auto,*">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="PROFILE VIEWER (R-Z)" FontSize="16" FontWeight="SemiBold" />
              <Button Grid.Column="1" Classes="ghost panel-close-btn" Click="HideVisualizationPanel_Click">‚úï</Button>
            </Grid>

            <Grid Grid.Row="1" RowDefinitions="*,Auto" Margin="0,10,0,0">
              <controls:RecipePlotControl Height="250"
                                         Points="{Binding Points}"
                                         SelectedPoint="{Binding SelectedPoint}"
                                         Progress="{Binding Progress}"
                                         Settings="{Binding AppSettings}" />

              <Grid Grid.Row="1" ColumnDefinitions="Auto,Auto,*,Auto" Margin="0,8,0,0">
                <Button Command="{Binding PlayPauseCommand}" Classes="accent">‚ñ∂ / ‚ùö‚ùö</Button>
                <Button Grid.Column="1" Command="{Binding StopCommand}" Classes="ghost">‚èπ</Button>

                <TextBlock Grid.Column="2" Text="–°–∫–æ—Ä–æ—Å—Ç—å" VerticalAlignment="Center" Classes="muted" />
                <Slider Grid.Column="3" Minimum="0.2" Maximum="3" Value="{Binding SpeedMultiplier}" Width="140" />
              </Grid>
            </Grid>
          </Grid>
        </Border>
        <Border x:Name="VisualizationResizeHandle" Classes="panel-resize-handle"
                PointerPressed="ResizeHandle_PointerPressed" PointerMoved="ResizeHandle_PointerMoved" PointerReleased="ResizeHandle_PointerReleased" />

        <Border x:Name="SelectedPointPanel" Classes="card floating-panel"
                Width="430" Height="280" MinWidth="340" MinHeight="220"
                PointerPressed="Panel_PointerPressed" PointerMoved="Panel_PointerMoved" PointerReleased="Panel_PointerReleased">
          <Grid RowDefinitions="Auto,*">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="–î–ï–¢–ê–õ–ò –¢–û–ß–ö–ò" FontSize="16" FontWeight="SemiBold" />
              <Button Grid.Column="1" Classes="ghost panel-close-btn" Click="HideSelectedPointPanel_Click">‚úï</Button>
            </Grid>

            <StackPanel Grid.Row="1" Spacing="8" Margin="0,10,0,0">
              <TextBlock Text="{Binding SelectedPoint}" Classes="muted" TextWrapping="Wrap" />
              <TextBlock Text="–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –≤ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç R/Z." Classes="muted" TextWrapping="Wrap" />
            </StackPanel>
          </Grid>
        </Border>
        <Border x:Name="SelectedPointResizeHandle" Classes="panel-resize-handle"
                PointerPressed="ResizeHandle_PointerPressed" PointerMoved="ResizeHandle_PointerMoved" PointerReleased="ResizeHandle_PointerReleased" />
      </Canvas>
    </Grid>
  </Grid>
</UserControl>
