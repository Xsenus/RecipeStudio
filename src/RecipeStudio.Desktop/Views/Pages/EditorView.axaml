<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="clr-namespace:RecipeStudio.Desktop.Controls"
             mc:Ignorable="d"
             x:Class="RecipeStudio.Desktop.Views.Pages.EditorView">

  <Grid RowDefinitions="Auto,*" Margin="18">

    <!-- Header -->
    <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,12">
      <Button Command="{Binding BackCommand}" Classes="ghost back-arrow" Width="42" Height="34" Padding="0"><TextBlock Text="‚Üê" HorizontalAlignment="Center" VerticalAlignment="Center" /></Button>

      <TextBlock Grid.Column="1" Text="–†–µ–¥–∞–∫—Ç–æ—Ä —Ä–µ—Ü–µ–ø—Ç–∞" Classes="h1" VerticalAlignment="Center" Margin="12,0,0,0" />

      <Button Grid.Column="2" Command="{Binding SaveCommand}" Classes="accent">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</Button>
    </Grid>

    <Grid Grid.Row="1">

      <!-- Left: table -->
      <Border Classes="card" Margin="0">
        <Grid RowDefinitions="Auto,*">

          <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,10">
            <Button Command="{Binding AddPointCommand}" Classes="good">+ –¢–æ—á–∫–∞</Button>
            <Button Command="{Binding DuplicatePointCommand}" Classes="ghost">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</Button>
            <Button Command="{Binding RemovePointCommand}" Classes="danger">–£–¥–∞–ª–∏—Ç—å</Button>
            <Button Command="{Binding MoveUpCommand}" Classes="ghost">‚Üë</Button>
            <Button Command="{Binding MoveDownCommand}" Classes="ghost">‚Üì</Button>
            <Button Command="{Binding RecalculateCommand}" Classes="ghost">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</Button>
            <Button Command="{Binding ShowChartsCommand}" Classes="ghost">–ì—Ä–∞—Ñ–∏–∫–∏</Button>

            <Button Command="{Binding ImportExcelCommand}" Classes="ghost">–ò–º–ø–æ—Ä—Ç Excel</Button>
            <Button Command="{Binding ExportExcelCommand}" Classes="ghost">–≠–∫—Å–ø–æ—Ä—Ç Excel</Button>

            <TextBlock Text="{Binding Document.RecipeId, StringFormat='ID: {0}'}" Classes="muted" Margin="12,0,0,0" VerticalAlignment="Center" />
          </StackPanel>

          <DataGrid Grid.Row="1" Classes="editor-grid" ItemsSource="{Binding Points}" VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                    SelectedItem="{Binding SelectedPoint}"
                    AutoGenerateColumns="False"
                    CanUserResizeColumns="True"
                    CanUserReorderColumns="True"
                    CanUserSortColumns="True"
                    IsReadOnly="False"
                    HeadersVisibility="All"
                    MinHeight="620"
>

            <DataGrid.Columns>

              <DataGridTextColumn Header="#" Binding="{Binding NPoint}" IsReadOnly="True" Width="45" />
              <DataGridCheckBoxColumn Header="A" Binding="{Binding Act}" Width="55" />
              <DataGridCheckBoxColumn Header="S" Binding="{Binding Safe}" Width="60" />

              <!-- Core input -->
              <DataGridTextColumn Header="R" Binding="{Binding RCrd}" Width="90" />
              <DataGridTextColumn Header="Z" Binding="{Binding ZCrd}" Width="90" />
              <DataGridTextColumn Header="place" Binding="{Binding Place}" Width="70" />
              <DataGridCheckBoxColumn Header="hidden" Binding="{Binding Hidden}" Width="75" />

              <DataGridTextColumn Header="a" Binding="{Binding ANozzle}" Width="90" />
              <DataGridTextColumn Header="Œ± rec" Binding="{Binding RecommendedAlfa}" IsReadOnly="True" Width="75" />
              <DataGridTextColumn Header="Œ±" Binding="{Binding Alfa}" Width="75" />
              <DataGridTextColumn Header="Œ≤" Binding="{Binding Betta}" Width="75" />

              <DataGridTextColumn Header="Speed" Binding="{Binding SpeedTable}" Width="70" />
              <DataGridTextColumn Header="Time" Binding="{Binding TimeSec}" IsReadOnly="True" Width="75" />
              <DataGridTextColumn Header="Vel" Binding="{Binding NozzleSpeedMmMin}" IsReadOnly="True" Width="95" />
              <DataGridTextColumn Header="Flow" Binding="{Binding RecommendedIceRate}" IsReadOnly="True" Width="75" />

              <DataGridTextColumn Header="Ice.R" Binding="{Binding IceRate}" Width="90" />
              <DataGridTextColumn Header="Ice.G" Binding="{Binding IceGrind}" Width="90" />
              <DataGridTextColumn Header="Air.P" Binding="{Binding AirPressure}" Width="75" />
              <DataGridTextColumn Header="Air.T" Binding="{Binding AirTemp}" Width="75" />

              <DataGridCheckBoxColumn Header="cont" Binding="{Binding Container}" Width="70" />
              <DataGridTextColumn Header="D form" Binding="{Binding DClampForm}" Width="90" />
              <DataGridTextColumn Header="D cont" Binding="{Binding DClampCont}" Width="90" />
              <DataGridTextColumn Header="Desc" Binding="{Binding Description}" Width="90" />

              <!-- Outputs -->
              <DataGridTextColumn Header="Xr" Binding="{Binding Xr0}" IsReadOnly="True" Width="80" />
              <DataGridTextColumn Header="Yr" Binding="{Binding Yx0}" IsReadOnly="True" Width="80" />
              <DataGridTextColumn Header="Zr" Binding="{Binding Zr0}" IsReadOnly="True" Width="80" />

              <DataGridTextColumn Header="dX" Binding="{Binding DX}" IsReadOnly="True" Width="80" />
              <DataGridTextColumn Header="dY" Binding="{Binding DY}" IsReadOnly="True" Width="80" />
              <DataGridTextColumn Header="dZ" Binding="{Binding DZ}" IsReadOnly="True" Width="80" />

              <DataGridTextColumn Header="dA" Binding="{Binding DA}" IsReadOnly="True" Width="80" />
              <DataGridTextColumn Header="aB" Binding="{Binding AB}" IsReadOnly="True" Width="80" />

              <DataGridTextColumn Header="Xp" Binding="{Binding XPuls}" IsReadOnly="True" Width="90" />
              <DataGridTextColumn Header="Yp" Binding="{Binding YPuls}" IsReadOnly="True" Width="90" />
              <DataGridTextColumn Header="Zp" Binding="{Binding ZPuls}" IsReadOnly="True" Width="90" />

              <DataGridTextColumn Header="Ap" Binding="{Binding APuls}" IsReadOnly="True" Width="90" />
              <DataGridTextColumn Header="Bp" Binding="{Binding BPuls}" IsReadOnly="True" Width="90" />

              <DataGridTextColumn Header="Top_p" Binding="{Binding TopPuls}" IsReadOnly="True" Width="95" />
              <DataGridTextColumn Header="Top_Hz" Binding="{Binding TopHz}" IsReadOnly="True" Width="90" />
              <DataGridTextColumn Header="Low_p" Binding="{Binding LowPuls}" IsReadOnly="True" Width="95" />
              <DataGridTextColumn Header="Low_Hz" Binding="{Binding LowHz}" IsReadOnly="True" Width="90" />
              <DataGridTextColumn Header="Clamp_p" Binding="{Binding ClampPuls}" IsReadOnly="True" Width="100" />

            </DataGrid.Columns>
          </DataGrid>

        </Grid>
      </Border>

      <!-- Right: movable panels -->
      <Grid RowDefinitions="Auto,*" Margin="0">
        <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Right" Margin="0,0,0,8">
          <Button Classes="ghost panel-icon-btn" ToolTip.Tip="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤" Click="ShowParametersPanel_Click">‚öô</Button>
          <Button Classes="ghost panel-icon-btn" ToolTip.Tip="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏" Click="ShowVisualizationPanel_Click">üìà</Button>
          <Button Classes="ghost panel-icon-btn" ToolTip.Tip="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏" Click="ShowSelectedPointPanel_Click">‚óé</Button>
          <Button Classes="ghost panel-icon-btn" ToolTip.Tip="–°–±—Ä–æ—Å–∏—Ç—å –ø–∞–Ω–µ–ª–∏" Click="ResetPanels_Click">‚Ü∫</Button>
        </StackPanel>

        <Canvas x:Name="PanelsCanvas" Grid.Row="1" ClipToBounds="True">
          <Border x:Name="ParametersPanel" Classes="card" Width="390" PointerMoved="Panel_PointerMoved" PointerReleased="Panel_PointerReleased">
            <StackPanel Spacing="10">
              <Grid ColumnDefinitions="*,Auto" PointerPressed="Panel_PointerPressed" PointerMoved="Panel_PointerMoved" PointerReleased="Panel_PointerReleased">
                <TextBlock Text="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã" FontSize="16" FontWeight="SemiBold" />
                <Button Grid.Column="1" Classes="ghost panel-close-btn" Click="HideParametersPanel_Click">‚úï</Button>
              </Grid>

              <Grid ColumnDefinitions="150,*" RowDefinitions="Auto,Auto,Auto,Auto">
                <TextBlock Text="Recipe" VerticalAlignment="Center" />
                <TextBox Grid.Column="1" Text="{Binding RecipeCode}" />

                <TextBlock Grid.Row="1" Text="Container" VerticalAlignment="Center" />
                <CheckBox Grid.Row="1" Grid.Column="1" IsChecked="{Binding ContainerPresent}">–ï—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä</CheckBox>

                <TextBlock Grid.Row="2" Text="D clamp form" VerticalAlignment="Center" />
                <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding DClampForm}" />

                <TextBlock Grid.Row="3" Text="D clamp cont" VerticalAlignment="Center" />
                <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding DClampCont}" />
              </Grid>
            </StackPanel>
          </Border>

          <Border x:Name="VisualizationPanel" Classes="card" Width="390" PointerMoved="Panel_PointerMoved" PointerReleased="Panel_PointerReleased">
            <StackPanel Spacing="10">
              <Grid ColumnDefinitions="*,Auto,Auto" PointerPressed="Panel_PointerPressed" PointerMoved="Panel_PointerMoved" PointerReleased="Panel_PointerReleased">
                <TextBlock Text="–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è" FontSize="16" FontWeight="SemiBold" />
                <TextBlock Grid.Column="1" Text="drag&amp;drop" Classes="muted" VerticalAlignment="Center" />
                <Button Grid.Column="2" Classes="ghost panel-close-btn" Click="HideVisualizationPanel_Click">‚úï</Button>
              </Grid>

              <controls:RecipePlotControl Height="320"
                                         Points="{Binding Points}"
                                         SelectedPoint="{Binding SelectedPoint}"
                                         Progress="{Binding Progress}"
                                         Settings="{Binding AppSettings}" />

              <Grid ColumnDefinitions="Auto,Auto,*,Auto" RowDefinitions="Auto,Auto">
                <Button Command="{Binding PlayPauseCommand}" Classes="accent">‚ñ∂ / ‚ùö‚ùö</Button>
                <Button Grid.Column="1" Command="{Binding StopCommand}" Classes="ghost">‚èπ</Button>

                <TextBlock Grid.Column="2" Text="–°–∫–æ—Ä–æ—Å—Ç—å" VerticalAlignment="Center" Classes="muted" />
                <Slider Grid.Column="3" Minimum="0.2" Maximum="3" Value="{Binding SpeedMultiplier}" Width="140" />

                <TextBlock Grid.Row="1" Grid.ColumnSpan="4" Text="–ü—Ä–æ–≥—Ä–µ—Å—Å" Classes="muted" />
                <Slider Grid.Row="1" Grid.ColumnSpan="4" Minimum="0" Maximum="1" Value="{Binding Progress}" />
              </Grid>

              <TextBlock Text="–õ–∏–Ω–∏—è: Robot/Tool path (–æ—Ä–∞–Ω–∂–µ–≤—ã–π), —Ç–æ—á–∫–∏: Safe=0/1 (–∑–µ–ª—ë–Ω—ã–π/—Ü–∏–∞–Ω)." Classes="muted" />
            </StackPanel>
          </Border>

          <Border x:Name="SelectedPointPanel" Classes="card" Width="390" PointerMoved="Panel_PointerMoved" PointerReleased="Panel_PointerReleased">
            <StackPanel Spacing="6">
              <Grid ColumnDefinitions="*,Auto" PointerPressed="Panel_PointerPressed" PointerMoved="Panel_PointerMoved" PointerReleased="Panel_PointerReleased">
                <TextBlock Text="–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞" FontSize="16" FontWeight="SemiBold" />
                <Button Grid.Column="1" Classes="ghost panel-close-btn" Click="HideSelectedPointPanel_Click">‚úï</Button>
              </Grid>
              <TextBlock Text="{Binding SelectedPoint}" Classes="muted" TextWrapping="Wrap" />
              <TextBlock Text="–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–ª–∏–∫ –ø–æ —Ç–æ—á–∫–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–æ–∫—É. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç R/Z." Classes="muted" TextWrapping="Wrap" />
            </StackPanel>
          </Border>
        </Canvas>
      </Grid>
    </Grid>
  </Grid>
</UserControl>
