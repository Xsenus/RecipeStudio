# Аудит RecipeStudio: переменные, БД, хедеры и построение графиков

Дата: 2026-02-19

## Что проверено

1. **Модель и имена свойств классов** (`RecipePoint`, `RecipeDocument`).
2. **Имена полей в SQLite** и соответствие полям модели (`RecipeRepository`).
3. **Имена хедеров** для TSV/CSV и Excel (`RecipeTsvSerializer`, `RecipeExcelService`).
4. **Источник и формулы расчетов** для вычисляемых полей (`RecipeCalculator`).
5. **Отрисовка графиков**:
   - профиль R-Z (`RecipePlotControl`),
   - аналитические графики (`RecipeAnalysisChartControl`).

---

## Результат проверки

## 1) Наименование переменных в классах

### Что хорошо
- Внутри `RecipePoint` и сервисов есть стабильное соответствие бизнес-полей (R/Z, alfa/betta, ice_rate, clamp и т.д.).
- Для вычисляемых значений (`Xr0`, `dX`, `Xpuls` и т.д.) сохранена совместимость с историческим форматом.

### Что требует внимания
- В проекте смешаны стили именования:
  - доменные legacy-имена из Excel (`betta`, `Yx0`, `aB`),
  - более ".NET-похожие" имена (`NozzleSpeedMmMin`, `RecommendedIceRate`).
- Термин `betta` в коде и БД не опечатка для этого проекта, но потенциальный источник путаницы (часто ожидают `beta`).

Рекомендация: оставить текущие имена как канонические для совместимости, но добавить единый словарь соответствий (см. раздел "Что доработать").

---

## 2) Наименование в БД

Проверка схемы `recipes` / `recipe_points` показала:
- Поля БД названы в `snake_case` и логично отражают поля модели (`r_crd`, `z_crd`, `recommended_alfa`, `nozzle_speed_mm_min`, `d_clamp_form`, `d_clamp_cont`, ...).
- Маппинг `SELECT/INSERT/UPDATE` в репозитории консистентный; критичных расхождений не найдено.

Риск: legacy-названия (`yx0`, `ab`) технически корректны, но слабочитаемы без контекста.

---

## 3) Наименование в хедерах (TSV/Excel)

### TSV/CSV
- Канонический порядок колонок фиксирован в `RecipeTsvSerializer.Columns`.
- `Load`/`Save` используют этот же набор имен: существенных рассинхронизаций нет.

### Excel
- Импорт уже был header-driven + частично tolerant к алиасам.
- По вашим скриншотам видны укороченные/вариантные заголовки (пример: `betta_c`, `speed_tab`, `air_pre`, `contai`, `d_clamp_f`, и т.п.), которые могли импортироваться не полностью.

**Сделано в этом коммите:** расширены алиасы Excel-хедеров, чтобы такие варианты тоже корректно подхватывались.

Добавленные алиасы:
- `a_nozz -> a_nozzle`
- `beta_crd`, `betta_c -> betta_crd`
- `speed_tab -> speed_table`
- `ice_grin -> ice_grind`
- `air_pre -> air_pressure`
- `air_tem -> air_temp`
- `contai -> container`
- `d_clamp_f -> d_clamp_form`
- `d_clamp -> d_clamp_cont`
- а также несколько вариантов для `recommended_alfa`.

---

## 4) Как считаются значения

Расчеты выполняет `RecipeCalculator.Recalculate`:

- `RecommendedAlfa` считается по соседним точкам (через `atan`, как в Excel-логике проекта).
- `TimeSec = 60 / SpeedTable`.
- `NozzleSpeedMmMin = R * 2 * 3.14 * SpeedTable` с округлением (используется `3.14` намеренно для соответствия шаблону Excel).
- `RecommendedIceRate` масштабируется относительно первой точки.
- Далее считаются CALC/SAVE поля (`Xr0`, `dX`, `Xpuls`, `TopHz`, `LowHz`, `ClampPuls` и т.д.).

Вывод: источник значений прозрачный и централизован в одном месте.

---

## 5) Как строится график и какие данные берутся

## 5.1 Профильный график (R-Z)
`RecipePlotControl` строит:
- **Target-путь** из `RCrd/ZCrd` с учетом `Place` и `HZone`.
- **Tool-путь** из расчетных `Xr0 + dX` и `Zr0 + dZ`.
- Ограничивающие контуры по зажимам (form/container) берутся из `DClamp*` + settings.

То есть для корректной картинки критично, чтобы перед отрисовкой был вызван `Recalculate()`.

## 5.2 Аналитический график
`RecipeAnalysisChartControl` строит серии по `ChartType`:
- **Speeds**: `IceRate`, `NozzleSpeedMmMin/60`, `SpeedTable`.
- **Angles**: `Alfa`, `Betta`.
- **Coordinates**: `ZCrd`, `Xr0+dX`, `Zr0+dZ`, `RCrd`.
- **Acceleration**: производная по соседним значениям `NozzleSpeedMmMin` с делением на `TimeSec`.

По оси X используются `NPoint` (или индекс, если `NPoint` пустой).

---

## Что доработать (приоритет)

1. **Словарь терминов (код ↔ Excel ↔ БД)**
   - Отдельный markdown/справочник с 1:1 соответствиями.
   - Особенно для неоднозначных имен: `betta`, `Yx0`, `aB`.

2. **Единая константная карта полей**
   - Сейчас имена частично дублируются в нескольких сервисах.
   - Свести к одному источнику, чтобы уменьшить риск рассинхронизации.

3. **Валидация Excel-импорта с отчетом**
   - Показывать, какие колонки не распознаны, а какие подставлены через alias.
   - Это сильно упростит диагностику "почему график пустой/ломаный".

4. **Автотесты на маппинг колонок**
   - Минимум: тесты на импорт нескольких вариантов хедеров (как на ваших скриншотах).
   - Тесты на round-trip: `Document -> Excel -> Document`.

5. **Имена легенд/осей графика скорости**
   - Сейчас серия `Flow Rate` берет `IceRate`, но ось подписана `V (mm/s)`.
   - Лучше развести подписи единиц (расход vs скорость), чтобы не вводить в заблуждение.

---

## Краткое заключение

Базовая архитектура (модель → расчет → БД/файлы → графики) рабочая и связная. Основные проблемы не в математике, а в **семантике имен и устойчивости к вариативным хедерам**. В этом коммите закрыт самый практичный риск: расширена совместимость Excel-импорта с альтернативными заголовками.


## Реализация доработок (выполнено)

- Добавлен единый каталог полей `RecipeFieldCatalog` и переведены сериализаторы TSV/Excel на общий источник колонок.
- В Excel-импорт добавлен расширенный отчёт (`RecipeImportReport`):
  - какие алиасы были применены,
  - какие неизвестные колонки встретились,
  - какие обязательные колонки отсутствуют,
  - какие дублирующиеся хедеры обнаружены (без падения импорта).
- В `EditorViewModel` добавлена сводка диагностики импорта (`ImportDiagnosticsSummary`), выводится в UI над таблицей.
- Для графика скоростей исправлены единицы правой оси: `Flow Rate` теперь подписан как `G (kg/h)`.
- Добавлен словарь соответствий `docs/recipe-field-dictionary.md`.
- Добавлены автотесты для импорта Excel-алиасов и диагностики неизвестных колонок (`tests/RecipeStudio.Tests`).
